apiVersion: v1
kind: ConfigMap
metadata:
  name: synesis-supervisor-config
  namespace: synesis-planner
  labels:
    app.kubernetes.io/part-of: synesis
    app.kubernetes.io/component: supervisor
data:
  supervisor.yaml: |
    # Erlang/OTP-style supervision configuration
    #
    # Each service has independent circuit breaker and retry settings.
    # When a circuit opens, the planner degrades gracefully rather than
    # failing completely.

    # Model endpoints: vLLM CPU (supervisor/critic) port 8080, CUDA (executor) port 8080
    services:
      synesis-supervisor:
        endpoint: "http://synesis-supervisor-predictor.synesis-models.svc.cluster.local:8080/v1"
        health_path: "/health"
        circuit_breaker:
          failure_threshold: 5
          reset_timeout_seconds: 60
          half_open_max_requests: 2
        retry:
          max_attempts: 3
          backoff_base_seconds: 0.5
          backoff_max_seconds: 5.0
        timeout_seconds: 30

      synesis-planner:
        endpoint: "http://synesis-supervisor-predictor.synesis-models.svc.cluster.local:8080/v1"
        health_path: "/health"
        circuit_breaker:
          failure_threshold: 5
          reset_timeout_seconds: 60
          half_open_max_requests: 2
        retry:
          max_attempts: 3
          backoff_base_seconds: 0.5
          backoff_max_seconds: 5.0
        timeout_seconds: 60

      synesis-executor:
        endpoint: "http://synesis-executor-predictor.synesis-models.svc.cluster.local:8080/v1"
        health_path: "/health"
        circuit_breaker:
          failure_threshold: 5
          reset_timeout_seconds: 60
          half_open_max_requests: 2
        retry:
          max_attempts: 3
          backoff_base_seconds: 1.0
          backoff_max_seconds: 10.0
        timeout_seconds: 60

      synesis-critic:
        endpoint: "http://synesis-critic-predictor.synesis-models.svc.cluster.local:8080/v1"
        health_path: "/health"
        circuit_breaker:
          failure_threshold: 5
          reset_timeout_seconds: 60
          half_open_max_requests: 2
        retry:
          max_attempts: 3
          backoff_base_seconds: 0.5
          backoff_max_seconds: 5.0
        timeout_seconds: 30

      milvus:
        endpoint: "http://synesis-milvus.synesis-rag.svc.cluster.local:9091"
        health_path: "/healthz"
        circuit_breaker:
          failure_threshold: 3
          reset_timeout_seconds: 30
          half_open_max_requests: 1
        retry:
          max_attempts: 2
          backoff_base_seconds: 0.5
          backoff_max_seconds: 5.0
        timeout_seconds: 10

      embedder:
        endpoint: "http://embedder.synesis-rag.svc.cluster.local:8080"
        health_path: "/health"
        circuit_breaker:
          failure_threshold: 3
          reset_timeout_seconds: 30
          half_open_max_requests: 1
        retry:
          max_attempts: 2
          backoff_base_seconds: 0.5
          backoff_max_seconds: 5.0
        timeout_seconds: 15

      lsp-gateway:
        endpoint: "http://lsp-gateway.synesis-lsp.svc:8000"
        health_path: "/health"
        circuit_breaker:
          failure_threshold: 3
          reset_timeout_seconds: 30
          half_open_max_requests: 1
        retry:
          max_attempts: 1
          backoff_base_seconds: 1.0
          backoff_max_seconds: 5.0
        timeout_seconds: 30

    # Dead-letter queue settings
    dead_letter:
      enabled: true
      max_queue_size: 1000
      log_level: "warning"

    # Global degradation policy
    degradation:
      executor_unavailable: "error_with_explanation"
      supervisor_unavailable: "skip_critique"
      planner_unavailable: "skip_to_worker"
      critic_unavailable: "skip_critique"
      # If RAG is down, generate without context
      rag_unavailable: "generate_without_context"
      # If LSP gateway is down, skip deep analysis (never blocks)
      lsp_unavailable: "skip_analysis"
