# Dev overlay WITHOUT model-serving. Use for day-to-day deploys when iterating on
# planner, webui, gateway, etc. Avoids InferenceService restarts (30+ min).
#
# Usage:
#   kustomize build overlays/dev-services | oc apply -f -
#
# Deploy models separately when needed (rare):
#   kustomize build overlays/dev -k overlays/dev-models  # no, that doesn't work
#   # Or apply model-serving by itself:
#   kustomize build overlays/dev | oc apply -f - -l app.kubernetes.io/component=model
#   # Simpler: just apply the model-serving base when models change:
#   kustomize build base/model-serving | oc apply -f -
#
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Same as dev, but EXCLUDES model-serving (InferenceServices, ServingRuntimes, etc.)
resources:
  - ../../base/gateway
  - ../../base/planner
  - ../../base/rag
  - ../../base/supervisor
  - ../../base/observability
  - ../../base/sandbox
  - ../../base/admin
  - ../../base/lsp
  - ../../base/search
  - ../../base/webui

patches:
  - target:
      kind: Deployment
      name: synesis-planner
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/env/12/value
        value: "none"
      - op: replace
        path: /spec/template/spec/containers/0/env/49/value
        value: "debug"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "250m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "512Mi"

  - target:
      kind: Deployment
      name: litellm-proxy
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "100m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "256Mi"

  - target:
      kind: Deployment
      name: lsp-gateway
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "500m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "1Gi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "1"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "2Gi"

  - target:
      kind: Deployment
      name: searxng
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "100m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "128Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "500m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "256Mi"

  - target:
      kind: Deployment
      name: synesis-warm-pool
    patch: |
      - op: replace
        path: /spec/replicas
        value: 1

  - target:
      kind: CronJob
      name: synesis-index-code
    patch: |
      - op: replace
        path: /spec/suspend
        value: true

  - target:
      kind: CronJob
      name: synesis-index-apispec
    patch: |
      - op: replace
        path: /spec/suspend
        value: true

  - target:
      kind: CronJob
      name: synesis-index-architecture
    patch: |
      - op: replace
        path: /spec/suspend
        value: true

  - target:
      kind: CronJob
      name: synesis-index-license
    patch: |
      - op: replace
        path: /spec/suspend
        value: true

  - target:
      kind: Deployment
      name: open-webui
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "100m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "256Mi"

  - target:
      kind: Deployment
      name: open-webui
    path: openwebui-direct-planner.yaml

  - target:
      kind: Deployment
      name: milvus-standalone
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "250m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "1Gi"

images:
  - name: synesis-planner
    newName: ghcr.io/supernovae/synesis/planner
    newTag: latest
  - name: synesis-admin
    newName: ghcr.io/supernovae/synesis/admin
    newTag: latest
  - name: synesis-lsp-gateway
    newName: ghcr.io/supernovae/synesis/lsp-gateway
    newTag: latest
  - name: synesis-sandbox
    newName: ghcr.io/supernovae/synesis/sandbox
    newTag: latest
  - name: synesis-bge-reranker
    newName: ghcr.io/supernovae/synesis/bge-reranker
    newTag: latest
  - name: synesis-ingestor
    newName: ghcr.io/supernovae/synesis/ingestor
    newTag: latest
  - name: synesis-indexer-code
    newName: ghcr.io/supernovae/synesis/indexer-code
    newTag: latest
  - name: synesis-indexer-apispec
    newName: ghcr.io/supernovae/synesis/indexer-apispec
    newTag: latest
  - name: synesis-indexer-architecture
    newName: ghcr.io/supernovae/synesis/indexer-architecture
    newTag: latest
  - name: synesis-indexer-license
    newName: ghcr.io/supernovae/synesis/indexer-license
    newTag: latest

labels:
  - pairs:
      synesis.io/environment: dev
    includeSelectors: false
