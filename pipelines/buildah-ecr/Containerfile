# Buildah + AWS CLI for Red Hat stack → ECR push
# Used by Manager and Executor ModelCar pipelines.
#
# Build and push to your ECR (from repo root):
#   ./pipelines/buildah-ecr/build.sh
# Use linux/amd64 for OpenShift/ROSA (x86_64 nodes).
#
FROM registry.access.redhat.com/ubi9/ubi:latest

# Buildah + AWS CLI v2 for ECR auth. awscli not in UBI repos; use official installer.
# curl-minimal is already in UBI; only install buildah + unzip to avoid curl conflict.
RUN dnf install -y buildah unzip --nodocs && dnf clean all && \
    curl -sSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o /tmp/awscliv2.zip && \
    unzip -q /tmp/awscliv2.zip -d /tmp && /tmp/aws/install && rm -rf /tmp/awscliv2.zip /tmp/aws

# Buildah needs storage dir; pipeline pods use emptyDir or /var/lib/containers
RUN mkdir -p /var/lib/containers && chmod 777 /var/lib/containers

# Buildah storage.conf — force vfs to avoid uid_map (OpenShift restricted SCC)
RUN mkdir -p /etc/containers
COPY storage.conf /etc/containers/storage.conf

# Copy wrapper scripts
COPY ecr-login-and-buildah-modelcar-pvc.sh /usr/local/bin/
COPY ecr-login-and-buildah.sh /usr/local/bin/
RUN sed -i 's/\r$//' /usr/local/bin/ecr-login-and-buildah-modelcar-pvc.sh /usr/local/bin/ecr-login-and-buildah.sh \
    && chmod +x /usr/local/bin/ecr-login-and-buildah-modelcar-pvc.sh /usr/local/bin/ecr-login-and-buildah.sh

WORKDIR /workspace
ENTRYPOINT ["/usr/local/bin/ecr-login-and-buildah.sh"]
