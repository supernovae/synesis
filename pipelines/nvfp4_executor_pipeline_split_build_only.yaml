# PIPELINE DEFINITION
# Name: synesis-nvfp4-executor-split-build-only
# Description: Build only â€” assumes executor model already on PVC (resume after failed build)
# Inputs:
#    ecr_uri: str [Default: '123456789012.dkr.ecr.us-east-1.amazonaws.com/synesis-models']
#    image_tag: str [Default: 'executor-nvfp4']
#    pvc_name: str [Default: 'executor-build-pvc']
components:
  comp-build-and-push-modelcar:
    executorLabel: exec-build-and-push-modelcar
    inputDefinitions:
      parameters:
        ecr_uri:
          parameterType: STRING
        image_tag:
          parameterType: STRING
deploymentSpec:
  executors:
    exec-build-and-push-modelcar:
      container:
        args:
        - /data/executor-model
        - '{{$.inputs.parameters[''ecr_uri'']}}'
        - '{{$.inputs.parameters[''image_tag'']}}'
        command:
        - /usr/local/bin/ecr-login-and-buildah.sh
        image: 660250927410.dkr.ecr.us-east-1.amazonaws.com/byron-ai-registry:buildah-ecr
        resources:
          cpuRequest: 2.0
          memoryLimit: 60.129542144
          memoryRequest: 8.589934592
          resourceCpuRequest: 2000m
          resourceMemoryLimit: 56Gi
          resourceMemoryRequest: 8Gi
pipelineInfo:
  description: "Build only \u2014 assumes executor model already on PVC (resume after\
    \ failed build)"
  name: synesis-nvfp4-executor-split-build-only
root:
  dag:
    tasks:
      build-and-push-modelcar:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-build-and-push-modelcar
        inputs:
          parameters:
            ecr_uri:
              componentInputParameter: ecr_uri
            image_tag:
              componentInputParameter: image_tag
        taskInfo:
          name: build-and-push-modelcar
  inputDefinitions:
    parameters:
      ecr_uri:
        defaultValue: 123456789012.dkr.ecr.us-east-1.amazonaws.com/synesis-models
        isOptional: true
        parameterType: STRING
      image_tag:
        defaultValue: executor-nvfp4
        isOptional: true
        parameterType: STRING
      pvc_name:
        defaultValue: executor-build-pvc
        isOptional: true
        parameterType: STRING
schemaVersion: 2.1.0
sdkVersion: kfp-2.16.0
---
platforms:
  kubernetes:
    deploymentSpec:
      executors:
        exec-build-and-push-modelcar:
          emptyDirMounts:
          - mountPath: /var/lib/containers
            volumeName: buildah-storage
          imagePullPolicy: Always
          pvcMount:
          - componentInputParameter: pvc_name
            mountPath: /data
            pvcNameParameter:
              componentInputParameter: pvc_name
          secretAsEnv:
          - keyToEnv:
            - envVar: AWS_ACCESS_KEY_ID
              secretKey: AWS_ACCESS_KEY_ID
            - envVar: AWS_SECRET_ACCESS_KEY
              secretKey: AWS_SECRET_ACCESS_KEY
            optional: false
            secretName: aws-ecr-credentials
            secretNameParameter:
              runtimeValue:
                constant: aws-ecr-credentials
          - keyToEnv:
            - envVar: AWS_SESSION_TOKEN
              secretKey: AWS_SESSION_TOKEN
            optional: true
            secretName: aws-ecr-session-token
            secretNameParameter:
              runtimeValue:
                constant: aws-ecr-session-token
