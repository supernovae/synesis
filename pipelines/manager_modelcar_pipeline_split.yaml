# PIPELINE DEFINITION
# Name: synesis-manager-modelcar-split
# Description: Build Manager ModelCar (download to PVC, then Kaniko) â€” avoids OOM
# Inputs:
#    ecr_uri: str [Default: '123456789012.dkr.ecr.us-east-1.amazonaws.com/synesis-models']
#    image_tag: str [Default: 'manager']
#    model_name: str [Default: 'manager']
#    model_repo: str [Default: 'nightmedia/Qwen3.5-35B-A3B-Text']
#    pvc_name: str [Default: 'modelcar-build-pvc']
components:
  comp-build-and-push-modelcar:
    executorLabel: exec-build-and-push-modelcar
    inputDefinitions:
      parameters:
        ecr_uri:
          parameterType: STRING
        image_tag:
          parameterType: STRING
        model_name:
          parameterType: STRING
  comp-download-model:
    executorLabel: exec-download-model
    inputDefinitions:
      parameters:
        model_repo:
          parameterType: STRING
deploymentSpec:
  executors:
    exec-build-and-push-modelcar:
      container:
        args:
        - '{{$.inputs.parameters[''ecr_uri'']}}'
        - '{{$.inputs.parameters[''image_tag'']}}'
        - '{{$.inputs.parameters[''model_name'']}}'
        command:
        - sh
        - -c
        - export CONTEXT_DIR=/data && exec /usr/local/bin/ecr-login-and-buildah-modelcar-pvc.sh
          "$1" "$2" "$3"
        image: 660250927410.dkr.ecr.us-east-1.amazonaws.com/byron-ai-registry:buildah-ecr
        resources:
          cpuRequest: 2.0
          memoryLimit: 60.129542144
          memoryRequest: 8.589934592
          resourceCpuRequest: 2000m
          resourceMemoryLimit: 56Gi
          resourceMemoryRequest: 8Gi
    exec-download-model:
      container:
        args:
        - --executor_input
        - '{{$}}'
        - --function_to_execute
        - download_model
        command:
        - sh
        - -c
        - "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip ||\
          \ python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1\
          \ python3 -m pip install --quiet --no-warn-script-location 'kfp==2.16.0'\
          \ '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"' && \"\
          $0\" \"$@\"\n"
        - sh
        - -ec
        - 'program_path=$(mktemp -d)


          printf "%s" "$0" > "$program_path/ephemeral_component.py"

          _KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         "$program_path/ephemeral_component.py"                         "$@"

          '
        - "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import\
          \ *\n\ndef download_model(model_repo: str):\n    \"\"\"Download HuggingFace\
          \ model to PVC. Lightweight \u2014 ~8Gi memory.\"\"\"\n    import subprocess\n\
          \    import sys\n\n    subprocess.run(\n        [sys.executable, \"-m\"\
          , \"pip\", \"install\", \"-q\", \"huggingface_hub[hf_transfer]\"],\n   \
          \     check=True,\n    )\n\n    import os\n\n    out = \"/data/models\"\n\
          \    if os.path.isfile(os.path.join(out, \"config.json\")):\n        print(\"\
          Model already on PVC, skipping download\")\n        return\n    os.makedirs(out,\
          \ exist_ok=True)\n    from huggingface_hub import snapshot_download\n\n\
          \    print(\"Downloading\", model_repo, \"->\", out)\n    snapshot_download(\n\
          \        repo_id=model_repo,\n        local_dir=out,\n        token=os.environ.get(\"\
          HF_TOKEN\") or None,\n    )\n    print(\"Done\")\n\n"
        image: python:3.12-slim
        resources:
          cpuRequest: 1.0
          memoryLimit: 8.589934592
          memoryRequest: 4.294967296
          resourceCpuRequest: 1000m
          resourceMemoryLimit: 8Gi
          resourceMemoryRequest: 4Gi
pipelineInfo:
  description: "Build Manager ModelCar (download to PVC, then Kaniko) \u2014 avoids\
    \ OOM"
  name: synesis-manager-modelcar-split
root:
  dag:
    tasks:
      build-and-push-modelcar:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-build-and-push-modelcar
        dependentTasks:
        - download-model
        inputs:
          parameters:
            ecr_uri:
              componentInputParameter: ecr_uri
            image_tag:
              componentInputParameter: image_tag
            model_name:
              componentInputParameter: model_name
        taskInfo:
          name: build-and-push-modelcar
      download-model:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-download-model
        inputs:
          parameters:
            model_repo:
              componentInputParameter: model_repo
        taskInfo:
          name: download-model
  inputDefinitions:
    parameters:
      ecr_uri:
        defaultValue: 123456789012.dkr.ecr.us-east-1.amazonaws.com/synesis-models
        isOptional: true
        parameterType: STRING
      image_tag:
        defaultValue: manager
        isOptional: true
        parameterType: STRING
      model_name:
        defaultValue: manager
        isOptional: true
        parameterType: STRING
      model_repo:
        defaultValue: nightmedia/Qwen3.5-35B-A3B-Text
        isOptional: true
        parameterType: STRING
      pvc_name:
        defaultValue: modelcar-build-pvc
        isOptional: true
        parameterType: STRING
schemaVersion: 2.1.0
sdkVersion: kfp-2.16.0
---
platforms:
  kubernetes:
    deploymentSpec:
      executors:
        exec-build-and-push-modelcar:
          emptyDirMounts:
          - mountPath: /var/lib/containers
            volumeName: buildah-storage
          imagePullPolicy: Always
          pvcMount:
          - componentInputParameter: pvc_name
            mountPath: /data
            pvcNameParameter:
              componentInputParameter: pvc_name
          secretAsEnv:
          - keyToEnv:
            - envVar: AWS_ACCESS_KEY_ID
              secretKey: AWS_ACCESS_KEY_ID
            - envVar: AWS_SECRET_ACCESS_KEY
              secretKey: AWS_SECRET_ACCESS_KEY
            optional: false
            secretName: aws-ecr-credentials
            secretNameParameter:
              runtimeValue:
                constant: aws-ecr-credentials
          - keyToEnv:
            - envVar: AWS_SESSION_TOKEN
              secretKey: AWS_SESSION_TOKEN
            optional: true
            secretName: aws-ecr-session-token
            secretNameParameter:
              runtimeValue:
                constant: aws-ecr-session-token
        exec-download-model:
          pvcMount:
          - componentInputParameter: pvc_name
            mountPath: /data
            pvcNameParameter:
              componentInputParameter: pvc_name
          secretAsEnv:
          - keyToEnv:
            - envVar: HF_TOKEN
              secretKey: HF_TOKEN
            optional: true
            secretName: hf-hub-secret
            secretNameParameter:
              runtimeValue:
                constant: hf-hub-secret
