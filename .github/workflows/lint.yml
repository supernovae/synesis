name: Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Run ShellCheck on all shell scripts
        run: |
          find scripts/ -name '*.sh' -type f | xargs shellcheck --severity=warning --shell=bash
          find base/ -name '*.sh' -type f | xargs shellcheck --severity=warning --shell=bash || true

  python:
    name: Python (ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ruff
        run: pip install ruff

      - name: Ruff check
        run: ruff check base/ --output-format=github

      - name: Ruff format check
        run: ruff format --check base/

  yaml:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: yamllint -c .yamllint.yml base/ overlays/ models.yaml

  kustomize:
    name: Kustomize Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        overlay: [dev, staging, prod]
    steps:
      - uses: actions/checkout@v4

      - name: Install kustomize
        run: |
          curl -sL "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Validate kustomize build (${{ matrix.overlay }})
        run: kustomize build overlays/${{ matrix.overlay }} > /dev/null

  hadolint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install hadolint
        run: |
          curl -sL -o hadolint "https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64"
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/

      - name: Lint Dockerfiles
        run: |
          status=0
          for df in $(find base/ -name 'Dockerfile' -type f | sort); do
            echo "--- $df ---"
            hadolint \
              --ignore DL3008 --ignore DL3013 --ignore DL3018 \
              --ignore DL3016 \
              --failure-threshold error \
              "$df" || status=1
          done
          exit "$status"
